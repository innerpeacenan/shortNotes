<!DOCTYPE html>
<html xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/web/css/bootstrap.css">
    <link rel="stylesheet" href="/web/css/index.css">
    <!--    <link href="/css/md.css" rel="stylesheet">-->
    <script src="/web/highlight/highlight.pack.js"></script>
    <link href="/web/highlight/styles/github.css" rel="stylesheet">
    <script src="/web/js/jquery-2.0.2.js"></script>
    <script src="/web/js/common.js"></script>
    <script src="/web/js/bootstrap.js"></script>
    <script src="/web/js/md.js"></script>
    <script src="/web/js/vue-2-3.js"></script>
    <script src="/web/js/config/api.js"></script>

</head>
<body>
<style>

</style>

<header>
    <nav>
        <div><a class="col-xs-6 AppHeader-navItem">首页</a></div>
        <a class="col-xs-6 AppHeader-navItem">用户</a>
    </nav>
</header>

<div class="clearfix"></div>

<div id="ffz_app" title="一个简易的todolist">
    <div v-bind:class="seen_items == 1 ? 'col-lg-4' : 'hide'">
        <items-panel></items-panel>
    </div>

    <div title="同时按下<CtrL>和<ENTER>,可隐藏或显示左侧导航栏" v-bind:class="seen_items == 1 ? 'col-lg-8' : 'col-lg-12'" tabindex="0"  v-on:keyup.ctrl.enter="toggleItemsTab()">
        <notes-panel></notes-panel>
    </div>
</div>




<script type="application/javascript">
    // 统一的全局状态管理
    var VGLOBAL = new Vue();

    Vue.directive('focus', {
        inserted: function (el) {
            el.focus()
        }
    });

    Vue.directive('highlightjs', {
        inserted: function (el) {
            var blocks = el.querySelectorAll('pre code');
            Array.prototype.forEach.call(blocks, hljs.highlightBlock);
        },
        update: function (el, binding, vnode, oldVnode) {
            if (vnode.data.domProps.innerHTML !== oldVnode.data.domProps.innerHTML) {
                var blocks = el.querySelectorAll('pre code');
                Array.prototype.forEach.call(blocks, hljs.highlightBlock);
            }

        }
    });

    var itemsPanel = Vue.component('items-panel', {
        data: function () {
            // 这些是什么含义? 没有注释啊
            return {
                settings :{
                    perpage:10 //设置首次加载个数

                },
                // 项目用到的常量都放到这里
                constant:{
                     visible_range : {
                        show_global: {
                            code: 20,
                            desc:"全局显示"
                        },
                        show_inside_parent:{
                            code:10,
                            desc:"只在父items下可见"
                        }
                    },
                    status:{
                        enable: {
                            code:10,
                            desc:"启用"
                        },
                        staging: {
                            code:20,
                            desc:"暂存"
                        },
                        draft: {
                            code: 30,
                            desc:"归档"
                        }
                    }
                },
                runtimeState:{
                    fid: '',
                    drag_from:{}, // 拖动的item
                    drag_to: {},  // 要拖动到的item
                },
                currentItem: '',
                // 所拥有的items集合
                items: []
            }
        },
        prop: [],
            // 组件初始化的钩子, 不能放到普通的 methods 中去
        created: function () {
            this.runtimeState.fid = getParam('fid');
            this.getItems();
            if(typeof VGLOBAL == 'undefined'){
                return;
            }
            // 监听重置分页选项事件
            VGLOBAL.$on('item-reset-limit-and-offset', function (item){
                // 保障 offset 整型,避免弱类型的坑
                this.item.limit = this.settings.perpage;
                this.item.offset = this.notes.length
            });
        },
        methods:{
            // 新建一个数据model
            newItem: function () {
                return {
                    id: 0,
                    fid: this.runtimeState.fid,
                    name: " ",// make it not empty, so it can be saved where click save button directively
                    rank: 0,
                    status: this.constant.status.enable.code,
                    visible_range: this.constant.visible_range.show_inside_parent.code,
                    // above are extra property
                    isChecked: 0,
                    seen: true, // make it editable
                    // 设置每个items在请求notes的时候设置的分页参数
                    limit: this.settings.perpage,
                    offset: 0,
                }
            },
            getItems: function () {
                var my = this;
                var fid = my.runtimeState.fid;
                $.ajax({
                    type: 'GET',
                    url: URL_Manager.items,
                    data: {
                        fid: fid,
                        status: [
                            my.constant.status.enable.code,
                        ],
                    },
                    success: function (result) {
                        var data = result.data;
                        if (Array.isArray(data) && data.length === 0) {
                            data = [my.newItem()];
                        } else {
                            data = data.map(function (one) {
                                one.seen = false;
                                // 初始化 page 参数
                                one.offset = 0;
                                one.limit = my.settings.perpage;
                                // 全局显示的和启用的都勾选，这样更加美观
                                one.isChecked = my.constant.status.staging.code == one.status ? 1 : 0;
                                return one;
                            });
                        }
                        my.items = data;
                        // 你监听还没不监听,我就是要通知,就是这么任性
                        VGLOBAL.$emit('items-change', my.items);
                    },
                    error: function (data) {
                        console.log(data)
                    }
                });
            },
            // 当点击上一级目录的时候触发
            parentDir: function () {
                var my = this;
                var id = this.runtimeState.fid;
                $.ajax({
                    data: {id: id},
                    url: URL_Manager.parentDir,
                    success: function (result) {
                        if (result.status) {
                            var data = result.data;
                            // 记录当前item的父ID
                            my.runtimeState.fid = data.dir;
                            // 更新相应的items列表
                            my.getItems()
                        }
                    }
                });
            },
            // 当点即一个items的时候, 进入一个items的子items
            subDir: function (item) {
                var that = this;
                // 记录当前items所在的父目录
                that.runtimeState.fid = item.id;
                // 请求该父目录下的所有itmes
                that.getItems();
            },
            // 单击添加按钮的时候
            add: function () {
                this.items.unshift(this.newItem());
            },
            // 单击编辑按钮的时候
            edit: function (item) {
                item.seen = !item.seen;
            },
            save: function (item) {
                var my = this;
                $.ajax({
                    type: 'put',
                    url: URL_Manager.item,
                    data: {id: item.id, name: item.name, fid: item.fid},
                    success: function (result) {
                        // 针对插入的情况下,取出最后插入的主键
                        if (item.id == 0) {
                            item.id = result.data.id;
                        }
                        item.seen = !item.seen;
                    }
                })
            },
            // 删除 items
            del: function (index) {
                var my = this;
                var item = my.items[index];
                $.ajax({
                    type: 'DELETE',
                    url: URL_Manager.item,
                    data: {id: my.items[index].id},
                    success: function (result) {
                        if (!result.status){
                            console.log('delete error', index, result)
                            return;
                        }
                        VGLOBAL.$emit('item-delete', item)
                        my.items.splice(index, 1);
                    }
                })
            },
            // 拖拽实践, 用来 items 排序
            drag: function (item) {
                this.runtimeState.drag_from = item;
                console.log('drag:', this.runtimeState, 'drag_end');
            },
            // 确定 rankFrom.rank 将要被修改的值, 并重新排序
            drop: function (item) {
                var my = this;
                var dragFrom = my.runtimeState.drag_from;
                var dragTo = my.runtimeState.drag_to = item;
                console.log('drop',dragFrom,dragTo, 'end' )
                var rankVal = 0;
                var toIndex = my.items.indexOf(item);
                if (parseInt(dragFrom.visible_range != dragTo.visible_range)) {
                    console.log('visible_range are the same', dragFrom.visible_range, dragTo.visible_range)
                }

                // 默认排序是降序的,因此判断是从下往上拖动了
                if (parseFloat(dragFrom.rank) < parseFloat(dragTo.rank)) {
                    toIndex = my.items.indexOf(dragTo);
                    // 最终要将元素移动到 prevIndex 和 toIndex 之间
                    if (toIndex - 1 < 0) {
                        // fix bug about rank error
                        rankVal = parseFloat(dragTo.rank) + 1 / 3;
                        console.log('case 1:', dragFrom.rank, dragTo.rank, rankVal);
                    } else {
                        var toPrev = my.items[toIndex - 1];// 移动目标item的前一个item
                        rankVal = (parseFloat(toPrev.rank) + parseFloat(dragTo.rank)) / 2;
                        console.log('case 2:', dragFrom.rank, dragTo.rank, toPrev.rank, rankVal);
                    }
                }
                // 从上往下移动
                else if (parseFloat(dragFrom.rank) > parseFloat(dragTo.rank)) {// 55->8
                    if (toIndex + 1 >= my.items.length) {
                        rankVal = parseFloat(dragTo.rank) - 1 / 3;
                        console.log('case 3:', dragFrom.rank, dragTo.rank, rankVal);
                    } else {
                        var toNext = my.items[toIndex + 1];
                        rankVal = (parseFloat(dragTo.rank) + parseFloat(toNext.rank)) / 2;
                        console.log('case 4:', dragFrom.rank, dragTo.rank, toNext.rank, rankVal);
                    }
                } else {
                    console.log('case 5:', dragFrom.rank, dragTo.rank)
                }
                // save rank
                $.ajax({
                    type: 'PUT',
                    url: URL_Manager.rank,
                    data: {
                        "dragFrom": dragFrom.id,
                        "dragTo": dragTo.id,
                        "rank": rankVal
                    },
                    success: function (result) {
                        if (!result.status) {
                            console.log('rank error', result)
                            return;
                        }else{
                            dragFrom.rank = result.data.rank;
                        }
                        my.sort()
                    }
                });
            },
            sort: function () {
                this.items.sort(function (a, b) {
                    // 返回值大于0 表示需要调整顺序
                    if (parseInt(a.visible_range) > parseInt(b.visible_range)) {
                        return -1;
                    }else if(a.visible_range < b.visible_range){
                        return 1;
                    } else {
                        // 降序排列
                        if (parseFloat(a.rank) > parseFloat(b.rank)) {
                            return -1;
                        } else if (parseFloat(a.rank) < parseFloat(b.rank)) {
                            return 1;
                        } else {
                            return 0;
                        }
                    }
                });
            },
            getNotes: function (item) {
                var my = this;
                // 完成 items 和 notes 的相互绑定
                item.offset = 0;
                item.limit = my.settings.perpage;
                VGLOBAL.$emit('should-get-notes', item, my.items)
            },
            toggleStatus: function (item, index) {
                var my = this;
                $.ajax({
                    type: 'PUT',
                    url: URL_Manager.itemDraft,
                    data: {
                        id: item.id
                    },
                    success: function (result) {
                        if(!result.status){
                            console.log('items send to draft failed!', item)
                            return;
                        }
                        my.items.splice(index, 1)
                        VGLOBAL.$emit('item-delete', item)
                    }
                })
            }
        },
        template: `
<div>
    <div class="panel panel-primary">
        <div class="panel-heading">
            <span class="glyphicon glyphicon-list"></span>事项列表
            <span v-on:click.stop="parentDir">上一级目录</span>
            <div class="pull-right action-buttons">
                <div class="btn-group pull-right">
                    <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                        <span class="glyphicon glyphicon-cog" style="margin-right: 0px;"></span>
                    </button>
                    <ul class="dropdown-menu slidedown">
                        <li><a href=""><span class="glyphicon glyphicon-pencil"></span>Edit</a></li>
                        <li><a href=""><span class="glyphicon glyphicon-trash"></span>Delete</a></li>
                        <li><a href=""><span class="glyphicon glyphicon-flag"></span>Flag</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="panel-body">
            <ul class="list-group" v-for="(item,index) in items">
                <li class="list-group-item" v-on:click.stop="getNotes(item)" draggable='true'
                    @dragstart="drag(item)"
                    @dragover.prevent @drop="drop(item)">
                    <div class="checkbox">
                        <input type="checkbox" v-on:click.stop="toggleStatus(item,index)" v-model="item.isChecked"
                               :disabled="item.status == 1"/>
                        <label for="checkbox">
                            <a style="display: inline-block" v-on:click.stop="subDir(item)" title="事项或目录ID,单击可进入目录"><span>{{item.id}}</span></a>

                            <span v-show="!item.seen">{{item.name}}</span>
                            <input v-model="item.name" v-on:click.stop="" v-show="item.seen"
                                   v-on:keyup.esc="save(item)">
                        </label>
                    </div>
                    <div class="pull-right action-buttons">
                        <a  title = "蓝色代表全局可见,灰色代表仅当前目录下可见"
                        v-bind:class="item.visible_range == 20 ? 'glyphicon glyphicon-globe' : 'glyphicon glyphicon-globe gray'"
                        ></a>
                        <a v-on:click.stop="add()"><span class="glyphicon glyphicon-plus-sign" title="添加新事项"></span></a>
                        <a v-on:click.stop="edit(item)"><span class="glyphicon glyphicon-pencil"
                                                              title="编辑事项"></span></a>
                        <a v-on:click.stop="save(item)"><span class="glyphicon glyphicon-saved" title="保存事项"></span></a>
                        <a @click.stop="" @dblclick.stop="del(index)"><span class="glyphicon glyphicon-trash"
                                                                            title="删除事项"></span></a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>
`,
    });



    var notesPanel = Vue.component('notes-panel', {
        'prop': [],
        data: function () {
            return {
                settings: {
                    // 单位是像素
                    textarea_default_height: 50
                },
                notes: [],
                // 记录当前的item
                item: {},
                // 记录当前的items,页面下拉选择框需要用到
                items:[]
            }
        },
        computed: {
            // a computed getter
            showMore: function () {
                // 当 limit 参数被设置未0的时候. 表征没有新的内容可以其请求了
                if (this.item) {
                    return this.item.limit
                } else {
                    // 页面刚加载进来的时候,不显示
                    return 0
                }
            }
        },
        created: function(){
            var my = this;
            // 接受来自全局变量的 item items
            VGLOBAL.$on('should-get-notes', function (item, items) {
                console.log('should-get-notes')
                my.item = item;
                my.items = items;
                my.doGetNotes(item)
            });

            VGLOBAL.$on('items-change', function (items) {
                console.log('item-change', 'my.item', my.item)
                my.items = items;
            });

            // 如果当前的笔记显示的是要删除的item的，则清空相关所有笔记
            VGLOBAL.$on('item-delete', function (item) {
                console.log('item-delete','item',item, 'my.item', my.item)
                if(item === my.item){
                   my.notes = [];
                }
            });
        },
        methods: {
            newNote: function () {
                if(typeof this.item == 'undefined') {
                    window.console.log.error('this.items is undefined')
                    var itemId = 0;
                }else {
                    var itemId = this.item.id;
                }
                return {
                    id: 0,
                    item_id: itemId,
                    content: "",
                    c_time: '',
                    seen: true,
                    modifiedContent: ""
                };
            },
            doGetNotes: function (item, type) {
                var my = this
                if(typeof item == "undefined"){
                    console.log('item is undefined', item)
                    return;
                }
                $.ajax({
                    type: "GET",
                    url: URL_Manager.getnotes,
                    data: {
                        item_id: item.id,
                        offset: item.offset,
                        limit: item.limit
                    },
                    success: function (result) {
                        var data = result.data;

                        if (Array.isArray(data) && data.length < item.limit) {
                            // 标志着再没有更多的笔记需要加载了
                            item.limit = 0
                        }

                        if (data.length === 0) {
                            if (!item.id){
                                return false;
                            }
                            // 设置是否为追加模式,如果是发展为模式,返回控列表,否则返回新的一条记录
                            // 主要处理第一次加载的时候的问题
                            data = 'append' === type ? [] : [my.newNote()]
                        } else {
                            data = data.map(function (note) {
                                note.md = marked(note.content, {sanitize: true});
                                note.seen = false;
                                return note;
                            });
                        }
                        my.notes = 'append' == type ? my.notes.concat(data) : data
                        item.offset = my.notes.length
                    }
                });
            },
            add: function () {
                if ((typeof this.item == 'undefined') || (!this.item.id)){
                    return false;
                }
                var note = this.newNote();
                // 在列表头部加一条数据
                this.notes.unshift(note);
                return true;
            },
            /**
             * auto-height 在编辑的时候,自动调整 textarea 高度
             * @param $event
             */
            h: function ($event) {
                /**
                 * 这种方案 50px 扩充一次高度
                 */
                var target = $event.target;
                // height string such as: 50px,need to get substring '50' from '50px'
                var heightString = target.style.height;
                var height = heightString.substring(0, heightString.length - 2);
                if (height < target.scrollHeight) {
                    target.style.height = $event.target.scrollHeight + this.settings.textarea_default_height + 'px';
                }
            },
            edit: function (note) {
                note.modifiedContent = note.content
                note.seen = true
            },
            save: function (note) {
                var my = this
                // 单击保存的时候，$event 为什么是 undefine 呢？
                if (!note.item_id) {
                    console.log('note is:' , note)
                    return
                }
                // 将原来的及时更新改为非及时，以提高性能
                note.content = note.modifiedContent;
                $.ajax({
                    type: 'POST',
                    url: URL_Manager.savenote,
                    data: {
                        id: note.id,
                        item_id: note.item_id,
                        content: note.content
                    },
                    success: function (result) {
                        // 为新增加 note 更新其对应 id 值
                        if (result.status) {
                            if (0 == note.id) {
                                note.id = result.data.id
                            }
                            // senitize 对 html 标签用实体替换，尽量避免跨站点脚本攻击
                            note.md = marked(note.content, {sanitize: true});
                        }
                        // 不管有没有实际更新数据,都自动保存数据
                        note.seen = false
                        my.item.offset = my.notes.length
                    }
                })
            },
            /**
             * delete 是 javascript 的保留字
             */
            del: function (index) {
                var my = this;
                $.ajax({
                    type: 'DELETE',
                    url: URL_Manager.deletenote,
                    data: {
                        id: this.notes[index].id
                    },
                    success: function (result) {
                        if (result.status) {
                            my.notes.splice(index, 1);
                            // 每次重新设置请求的起点,保证所请求的数据能够连接起来
                            my.item.offset = my.notes.length
                        }
                    }
                })
            },
            mv: function (note, index) {
                var my = this;
                $.ajax({
                    type: 'PUT',
                    url: URL_Manager.movenote,
                    data: {
                        id: note.id,
                        itemId: note.item_id
                    },
                    success: function (result) {
                        if (result.status) {
                            my.notes.splice(index, 1);
                            my.item.offset = my.notes.length
                        }
                    }
                })
            },
            //获取更多数据
            more: function () {
                if(!this.item){
                    return;
                }
                VGLOBAL.$emit('item-update-limit-and-offset', this.item);
                this.doGetNotes(this.item, type = 'append')
            },
        },

        template: `
<div class="panel-heading">
    <div>
        <ul>
            <li v-for="(note,index) in notes" title="笔记唯一编号" :id="'note_' + note.id">
                <span>{{note.id}}</span>
                <span class="hidden-xs" title="创建时间">{{note.c_time}}</span>
                <span>
                <select title="选择其他目录,则自动将笔记移动到其他目录下了" class="items" v-model="note.item_id" @change="mv(note,index)">
                    <template v-if="note.item_id == item.id">
                    <option v-for="item in items" :value="item.id" selected>{{item.name}}</option>
                    </template>
                    <template v-else>
                    <option v-for="item in items" :value="item.id">{{item.name}}</option>
                    </template>
            </select>
            </span>
                <div class="pull-right action-buttons">
                <span v-on:click.stop="add()">
                    <a class="glyphicon glyphicon-plus-sign" title="添加笔记">
                    </a>
                </span>
                    &nbsp;
                    <span v-on:click.stop="edit(note, $event)">
                    <a class="glyphicon glyphicon-edit" title="编辑笔记">
                    </a>
                </span>
                    &nbsp;
                    <span v-on:click.stop="save(note)">
                    <a class="glyphicon glyphicon-saved" title="保存笔记">
                    </a>
                </span>
                    &nbsp;&nbsp;
                    <span v-on:click.stop="" v-on:dblclick="del(index)">
                    <a class="glyphicon glyphicon-trash" title="删除笔记"></a>
                </span>
                </div>
                <div>
                <textarea class="col-xs-12" v-if="note.seen" v-model="note.modifiedContent"
                          v-on:keyup.esc="save(note)"
                          v-on:keyup.enter="h($event)" @focus="h($event, note)" @paste="h($event, note)"
                          v-focus>
                </textarea>
                    <div class="textarea" v-if="!note.seen" @dblclick.stop="edit(note)"
                         v-html="note.md" v-highlightjs></div>
                </div>
            </li>
        </ul>
        <div class="text-center more" v-on:click.stop="more()" v-show="showMore">更多</div>
    </div>
</div>
`,
    });

new Vue({
    el: '#ffz_app',
    data: {
        seen_items : 1,
    },
    methods: {
        toggleItemsTab : function () {
            console.log('toggleItemsTab trigger')
            this.seen_items = this.seen_items == 1 ? 0 : 1 ;
        }
        // 子组件变化通知到父组件, 父组件变化在通知到另外一个子组件
    },
    components: {
        'items-panel': itemsPanel,
        'notes-panel': notesPanel,
    }
});
</script>


<!--用来清除浮动, 针对pull-right-->
<div class="clearfix"></div>
<!--footer-->
<footer class="row">
    <p class="text-center">
        <i>2016 All rights reserved</i><i>nxn copyright</i>
    </p>
</footer>


</body>
</html>
